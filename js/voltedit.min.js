"includes"in String.prototype||(String.prototype.includes=function(token){return this.indexOf(token)>=0}),"includes"in Array.prototype||(Array.prototype.includes=function(token){return this.indexOf(token)>=0});class AATree{constructor(initData){this.size=0,this.root=null,initData&&initData.forEach(data=>{this.add(data.y,data.l||0,data.data)})}add(y,l,data){const node=new AATreeNode(+y,+l,data);if(this.root){const prev=this.root._insert(node);return prev?[!1,prev]:(++this.size,[!0,node])}return this._setChild(node),++this.size,[!0,node]}get(y){return this.root?this.root._get(y):null}intersects(y,l){return!!this.root&&this.root._intersects(y,l)}first(){return this.root?this.root.first():null}last(){return this.root?this.root.last():null}traverse(visitor){this.root&&this.root.traverse(visitor)}_setChild(node){this.root=node,node._parent=this}_removeChild(node){this.root=null}_adjustAfterRemove(){}_notifyRemove(){--this.size}}class AATreeNode{constructor(y,l,data){this.y=y,this.l=l,this.data=data,this._level=1,this._left=null,this._right=null,this._parent=null}remove(){this._notifyRemove(),this._remove(null)}first(){return this._left?this._left.first():this}last(){return this._right?this._right.last():this}next(){return this._right?this._right.first():null}prev(){return this._left?this._left.last():null}traverse(visitor){this._left&&this._left.traverse(visitor),visitor(this),this._right&&this._right.traverse(visitor)}_remove(from){if(this._isLeaf()){const parent=this._parent;return parent._removeChild(this),void parent._adjustAfterRemove(from)}if(this._left){const l=this.prev();l._remove(this),this._set(l)}else{const l=this.next();l._remove(this),this._set(l)}this._adjustAfterRemove(from)}_adjustAfterRemove(stop){if(this===stop)return;const parent=this._parent;this._decreaseLevel();let newTree=this._skew();newTree._right&&newTree._right._skew(),newTree._right&&newTree._right._right&&newTree._right._right._skew(),(newTree=newTree._split())._right&&newTree._right._split(),parent._adjustAfterRemove(stop)}_set(node){this.y=node.y,this.l=node.l,this.data=node.data}_notifyRemove(){this._parent._notifyRemove()}_isLeaf(){return!(this._left||this._right)}_get(y){return y<this.y?this._left?this._left._get(y):null:y>this.y+this.l?this._right?this._right._get(y):null:this}_intersects(y,l){return y+l<this.y?!!this._left&&this._left._intersects(y,l):!(this.y+this.l<y)||!!this._right&&this._right._intersects(y,l)}_replaceChild(node,repl){node.y<this.y?this._left=repl:this._right=repl,repl&&(repl._parent=this)}_setChild(node){this._replaceChild(node,node)}_removeChild(node){this._replaceChild(node,null)}_insert(node){if(node.y===this.y)return this;if(node.y<=this.y){if(node.y+node.l>=this.y)return this;if(this._left){const result=this._left._insert(node);if(result)return result}else this._setChild(node)}else if(node.y>this.y){if(this.y+this.l>=node.y)return this;if(this._right){const result=this._right._insert(node);if(result)return result}else this._setChild(node)}return this._skew()._split(),null}_skew(){if(!this._left)return this;if(this._left._level!==this._level)return this;const left=this._left,parent=this._parent;return left._right?this._setChild(left._right):this._left=null,left._setChild(this),parent._setChild(left),left}_split(){if(!this._right||!this._right._right)return this;if(this._level!==this._right._right._level)return this;const right=this._right,parent=this._parent;return right._left?this._setChild(right._left):this._right=null,right._setChild(this),parent._setChild(right),++right._level,right}_decreaseLevel(){const levelOf=node=>node?node._level:0,shouldBe=Math.min(levelOf(this._left),levelOf(this._right))+1;shouldBe<this._level&&(this._level=shouldBe,shouldBe<levelOf(this._right)&&(this._right._level=shouldBe))}}const RD=Math.round,RDH=x=>RD(x+.5)-.5,CLIP=(x,a,b)=>x<a?a:x>b?b:isFinite(x)?x:a,ALIGN=(a,x)=>x%a==0?x:RD(x/a)*a,QUAD=(points,[ax,ay],[bx,by],[cx,cy],[dx,dy])=>points.push(ax,ay,0,bx,by,0,cx,cy,0,ax,ay,0,cx,cy,0,dx,dy,0),TOUCH=func=>event=>{const changedTouches=event.changedTouches;!changedTouches||changedTouches.length<1||func(changedTouches[0])},KEYCODE=event=>{if("code"in event)return event.code;const which=event.which||event.keyCode||0;if(!which)return"";if(which>=48&&which<=57)return`Digit${which-48}`;if(which>=65&&which<=90)return`Key${String.fromCharCode(which)}`;if(which>=96&&which<=105)return`Numpad${which-96}`;if(which>=112&&which<=123)return`F${which-111}`;const altLoc="location"in event&&event.location>1?2===event.location?"Right":"Numpad":"Left";switch(which){case 3:return"Pause";case 8:return"Backspace";case 9:return"Tab";case 13:return"Numpad"===altLoc?"NumpadEnter":"Enter";case 16:return`Shift${altLoc}`;case 17:return`Control${altLoc}`;case 18:return`Alt${altLoc}`;case 19:return"Pause";case 20:return"CapsLock";case 21:return"AltRight";case 25:return"ControlRight";case 27:return"Escape";case 32:return"Space";case 33:return"PageUp";case 34:return"PageDown";case 35:return"End";case 36:return"Home";case 37:return"ArrowLeft";case 38:return"ArrowUp";case 39:return"ArrowRight";case 40:return"ArrowBottom";case 45:return"Insert";case 46:return"Delete";case 91:return"MetaLeft";case 144:return"NumLock";case 145:return"ScrollLock";case 172:return"BrowserHome";case 173:return"AudioVolumeMute";case 174:return"AudioVolumeDown";case 175:return"AudioVolumeUp";case 176:return"MediaTrackNext";case 177:return"MediaTrackPrevious";case 178:return"MediaStop";case 179:return"MediaPlayPause";case 180:return"LaunchMail";case 186:return"Semicolon";case 187:return"Equal";case 188:return"Comma";case 189:return"Minus";case 190:return"Period";case 191:return"Slash";case 192:return"Backquote";case 219:return"BracketLeft";case 220:return"Backslash";case 221:return"BracketRight";case 222:return"Quote"}return""},SIMPLECODE=event=>{let code=KEYCODE(event);if(0===code.length)return"";mainKey:do{switch(code){case"BracketLeft":code="[";break mainKey;case"BracketRight":code="]";break mainKey;case"Semicolon":code=";";break mainKey;case"ControlLeft":code="Ctrl";break mainKey;case"ControlRight":code="CtrlRight";break mainKey;case"Escape":code="Esc";break mainKey}if(code.startsWith("Key")){code=code.slice(3);break mainKey}(code.startsWith("Digit")||code.startsWith("Arrow"))&&(code=code.slice(5)),code.endsWith("Left")&&"Left"!==code&&(code=code.slice(0,-4))}while(0);return event.shiftKey&&!code.startsWith("Shift")&&(code=`Shift+${code}`),event.altKey&&!code.startsWith("Alt")&&(code=`Alt+${code}`),event.ctrlKey&&!code.startsWith("Ctrl")&&(code=`Ctrl+${code}`),code},L10N=(lines=>{let data={},currKey="";return L10N_STRING.trim().split("\n").forEach(line=>{if("#"!==line[0])if(" "===line[0]||"\t"===line[0]){if(""===(line=line.trim()))return;currKey in data||(data[currKey]={});const match=line.match(/^([a-z\-]+):\s*(\S.*)$/i);match&&(data[currKey][match[1].toLowerCase()]=match[2])}else{if(""===line)return;currKey=line.trim()}}),Object.freeze(data),{_d:data,_l:"en",t:function(id){if(!(id in this._d))return id;const values=this._d[id];return this._l in values?values[this._l]:id},l:function(l){this._l=l.toLowerCase(),[].forEach.call(document.querySelectorAll("button,span,h1,h2,h3,h4,h5,h6,label"),elem=>{[].forEach.call(elem.classList,className=>{let id="";switch(elem.tagName.toUpperCase()){case"BUTTON":id=className;break;default:if(!className.startsWith("txt-"))return;id=className.slice(4)}id in this._d&&(elem.innerText=this.t(id))})})}}})();L10N_STRING="";class VSettings{constructor(){this.fields={},this.settings={},this._setFields(),this._reset();const savedSettingsStr=window.localStorage.getItem("voltedit:settings");if(savedSettingsStr)try{const savedSettings=JSON.parse(savedSettingsStr);if(savedSettings)for(let key in savedSettings)key in this.fields&&(this.settings[key]=savedSettings[key])}catch(e){console.error(e)}}_setFields(){this._define("ui:language","en"),this._define("editor:note:width",9),this._define("editor:margin:side",15),this._define("editor:margin:bottom",40),this._define("editor:measure:scale",20),this._define("editor:columns",1)}_define(key,defaultValue){this.fields[key]={defaultValue:defaultValue}}set(key,value){if(key)if(key in this.fields){if(this.settings[key]===value)return;this.settings[key]=value,this.save()}else console.error(`Key '${key}' does not exist in settings!`)}get(key){return key?key in this.settings?this.settings[key]:key in this.fields?this.fields[key].defaultValue:(console.error(`Key '${key}' does not exist in settings!`),null):null}isSet(key){return key in this.settings}isConfig(key){return key in this.fields}defaultValue(key){return this.fields[key].defaultValue}save(){window.localStorage.setItem("voltedit:settings",JSON.stringify(this.settings))}reset(){this._reset(),this.save()}_reset(){this.settings={}}}class VChartData{constructor(){this.version="Unknown VOLTEdit chart data",this.meta={title:"",artist:"",chart_author:"",difficulty:{idx:0},level:1},this.beat={bpm:new AATree([{y:0,data:120}]),resolution:240},this.gauge={},this.note={},this.audio={},this.camera={},this.bg={},this.impl={}}getNoteData(type,lane){return this.note&&type in this.note?this.note[type][lane]:null}addNote(type,lane,tick,len){return this.note||(this.note={}),this.note[type]||(this.note[type]=[]),this._initTreeArr(this.note[type],lane+1),this.getNoteData(type,lane).add(tick,len,null)}delNote(type,lane,tick){const noteData=this.getNoteData(type,lane);if(!noteData)return!1;const node=noteData.get(tick);return!(!node||node.y!==tick)&&(node.remove(),!0)}getLastTick(){let lastTick=0;const check=tick=>{lastTick<tick&&(lastTick=tick)},checkTree=tree=>{const last=tree.last();last&&check(last.y+last.l)};if(this.note&&(this.note.bt&&this.note.bt.map(checkTree),this.note.fx&&this.note.fx.map(checkTree),this.note.laser&&this.note.laser.map(checkTree)),this.beat){if(checkTree(this.beat.bpm),this.beat.time_sig&&this.beat.time_sig.length>0){const tickPerWhole=4*(this.beat.resolution||240);let measureTick=0,prevMeasureInd=0,prevMeasureLen=tickPerWhole;this.beat.time_sig.forEach(sig=>{measureTick+=(sig.idx-prevMeasureInd)*prevMeasureLen,prevMeasureInd=sig.idx,prevMeasureLen=sig.v.n*tickPerWhole/sig.v.d}),check(measureTick)}this.beat.scroll_speed&&this.beat.scroll_speed.length}return lastTick}toKSON(){const kson={version:this.version,meta:this.meta,beat:this.beat,gauge:this.gauge,note:this._getKSONNote(),audio:this.audio,camera:this.camera,bg:this.bg,impl:this.impl};return JSON.stringify(kson)}_getKSONNote(){const note2arr=tree=>{const arr=[];return tree.traverse(node=>{const obj={y:node.y};node.l&&(obj.l=node.l),arr.push(obj)}),arr};return{bt:this.note.bt.map(note2arr),fx:this.note.fx.map(note2arr),laser:this.note.laser.map(tree=>{const arr=[];return tree.traverse(node=>{const obj={y:node.y};for(let k in node.data)obj[k]=node.data[k];arr.push(obj)}),arr})}}_initTreeArr(arr,size){for(;arr.length<size;)arr.push(new AATree)}}VChartData.create=function(file){if("{"===file[0]){const kson=KSONData.create(file);if(null!==kson)return kson}return KSHData.create(file)};const KSH_DEFAULT_MEASURE_TICK=192,KSH_LASER_SLAM_TICK=KSH_DEFAULT_MEASURE_TICK/32,KSH_LASER_VALUES="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmno",KSH_LASER_LOOKUP=Object.freeze((str=>{const dict={};for(let i=0;i<str.length;++i)dict[str[i]]=i;return dict})(KSH_LASER_VALUES)),KSH_LINE_TYPE=Object.freeze({HEADER:0,BODY:1}),KSH_REGEX=Object.freeze({OPTION:/^([^=]+)=(.+)$/,LINE:/^([012]{4})\|(.{2})\|([0-9A-Za-o\-:]{2})(?:(@\(|@\)|@<|@>|S<|S>)([0-9;]+))?$/});class KSHTimeSig{constructor(str){const timeSig=this.timeSig=str.split("/").map(x=>parseInt(x));if(2!=timeSig.length||timeSig.some(x=>!isFinite(x)||x<1))throw new Error("Invalid ksh time signature! [invalid value]");if(KSH_DEFAULT_MEASURE_TICK%timeSig[1]!=0)throw new Error("Invalid ksh time signature! [invalid denom]")}toKSON(){return{n:this.timeSig[0],d:this.timeSig[1]}}}class KSHLine{constructor(match,mods){this.bt=match[1],this.fx=match[2],this.laser=match[3],this.rot=match[4]||"",this.mods=mods||[],this.tick=0,this.len=0}}class KSHGraph{constructor(isRelative,options){this.isRelative=isRelative,isRelative?(this.collapseTick=options.collapseTick||0,this.range=options.range||1,this.iy=options.y||0):(this.collapseTick=0,this.range=1,this.iy=0),this.ys=[],this.vs=[],this.vfs=[]}push(y,v){let lastInd=this.ys.length-1;if(y<this.ys[lastInd])throw new Error("Invalid insertion order in KSHGraph!");y<=this.ys[lastInd]+this.collapseTick?this.vfs[lastInd]=v:(this.ys.push(y),this.vs.push(v),this.vfs.push(v))}getLength(){return this.ys.length?this.ys[this.ys.length-1]-this.iy:0}toKSON(){let segments=[];for(let i=0;i<this.ys.length;i++){let segment={v:this.vs[i]};segment[this.isRelative?"ry":"y"]=this.ys[i]-this.iy,this.vfs[i]!=this.vs[i]&&(segment.vf=this.vfs[i]),segments.push(segment)}return segments}}class KSHParser{constructor(ksh){this.ksh=ksh,this.currLineType=KSH_LINE_TYPE.HEADER,this.queue=[],this.modifiers=[]}readLine(line){if(""!==line)switch(this.currLineType){case KSH_LINE_TYPE.HEADER:return this._readHeaderLine(line);case KSH_LINE_TYPE.BODY:return this._readBodyLine(line)}}end(){this.queue.length>0&&(console.warn("Processing a KSH file with no `--` at the end..."),this._onReadMeasure())}_readHeaderLine(line){if("--"===line)return void(this.currLineType=KSH_LINE_TYPE.BODY);const match=line.match(KSH_REGEX.OPTION);if(null===match)return;const[key,value]=[match[1],match[2]];this.ksh.setKSHMeta(key,value)}_readBodyLine(line){if("--"===line)return void this._onReadMeasure();if("#"===line[0])return;let match=line.match(KSH_REGEX.OPTION);if(!match)return(match=line.match(KSH_REGEX.LINE))?(this.queue.push(new KSHLine(match,this.modifiers)),void(this.modifiers=[])):void 0;this.modifiers.push([match[1],match[2]])}_onReadMeasure(){this.ksh.addKSHMeasure(this.queue),this.queue=[]}}class KSHData extends VChartData{constructor(str){super(),this.parser=new KSHParser(this),this._ksmMeta={version:"ksh"},this._ksmMeasures=[],str.split("\n").map(line=>this.parser.readLine(line.replace(/^[\r\n\uFEFF]+|[\r\n]+$/g,""))),this.parser.end(),this._setKSONData()}setKSHMeta(key,value){this._ksmMeta[key]=value}addKSHMeasure(measure){this._ksmMeasures.push(measure)}_getDiffIdx(){switch((this._ksmMeta.difficulty||"").trim().toLowerCase()){case"light":return 0;case"challenge":return 1;case"extended":return 2;case"infinite":default:return 3}}_setKSONData(){if(this._setKSONVersion(),this._setKSONMeta(),this._setKSONBgmInfo(),"total"in this._ksmMeta){let total=parseInt(this._ksmMeta.total);if(!isFinite(total))throw new Error("Invalid ksh `total` value!");total<100&&(total=100),this.gauge={total:total}}this._setKSONBeatInfo(),this._setKSONNoteInfo()}_setKSONVersion(){const ver=(this._ksmMeta.ver||"").trim();this.version=ver?`ksh ${ver}`:"ksh"}_setKSONMeta(){const meta=this.meta={},ksmMeta=this._ksmMeta;if(meta.title=ksmMeta.title||"",meta.artist=ksmMeta.artist||"",meta.chart_author=ksmMeta.effect||"",meta.level=(level=>!isFinite(level)||level<1?1:level>20?20:level)(parseInt(ksmMeta.level||1)),meta.difficulty={idx:this._getDiffIdx()},"difficulty"in ksmMeta&&(meta.difficulty.name=ksmMeta.difficulty),"t"in ksmMeta&&(meta.disp_bpm=ksmMeta.t),"to"in ksmMeta&&(meta.std_bpm=parseFloat(ksmMeta.to),!isFinite(meta.std_bpm)||meta.std_bpm<0))throw new Error("Invalid ksh `to` value!");"jacket"in ksmMeta&&(meta.jacket_filename=ksmMeta.jacket),"illustrator"in ksmMeta&&(meta.jacket_author=ksmMeta.illustrator),"information"in ksmMeta&&(meta.information=ksmMeta.information)}_setKSONBgmInfo(){const bgmInfo=this.audio.bgm={},ksmMeta=this._ksmMeta;if("m"in ksmMeta){const m=ksmMeta.m.split(";")[0];""!==m&&(bgmInfo.filename=m)}if("mvol"in ksmMeta){const mvol=parseInt(ksmMeta.mvol);isFinite(mvol)&&100!=mvol&&mvol>=0&&(bgmInfo.vol=mvol)}if("o"in ksmMeta){const offset=parseInt(ksmMeta.o);isFinite(offset)&&0!=offset&&(bgmInfo.offset=offset)}if("po"in ksmMeta){const preview_offset=parseInt(ksmMeta.po);isFinite(preview_offset)&&preview_offset>0&&(bgmInfo.preview_offset=preview_offset)}if("plength"in ksmMeta){const preview_duration=parseInt(ksmMeta.plength);isFinite(preview_duration)&&preview_duration>0&&(bgmInfo.preview_duration=preview_duration)}}_setKSONBeatInfo(){const beatInfo=this.beat={bpm:new AATree,time_sig:[],scroll_speed:new AATree,resolution:KSH_DEFAULT_MEASURE_TICK/4},ksmMeta=this._ksmMeta;"beat"in ksmMeta&&beatInfo.time_sig.push({idx:0,v:new KSHTimeSig(ksmMeta.beat).toKSON()});let measure_tick=0,time_sig=[4,4];this._ksmMeasures.forEach((measure,measure_idx)=>{if(0===measure.length)throw new Error("Malformed ksh measure!");measure[0].mods.forEach(([key,value])=>{switch(key){case"beat":const newTimeSig=new KSHTimeSig(value);time_sig=newTimeSig.timeSig,beatInfo.time_sig.push({idx:measure_idx,v:newTimeSig.toKSON()})}});const measure_len=KSH_DEFAULT_MEASURE_TICK/time_sig[1]*time_sig[0];if(measure_len%measure.length!=0)throw new Error("Invalid ksh measure line count!");const tick_per_line=measure_len/measure.length;measure.forEach((kshLine,line_idx)=>{let tick=kshLine.tick=measure_tick+tick_per_line*line_idx;kshLine.len=tick_per_line,kshLine.mods.forEach(([key,value])=>{const intValue=parseInt(value),floatValue=parseFloat(value);switch(key){case"beat":if(line_idx>0)throw new Error("Invalid ksh time signature! [invalid location]");break;case"t":if(tick>0&&this._tryAddBPMFromMeta(),floatValue<=0||!isFinite(floatValue))throw new Error("Invalid ksh BPM value!");beatInfo.bpm.add(tick,0,floatValue);break;case"stop":if(intValue<=0||!isFinite(intValue))throw new Error("Invalid ksh stop length!")}})}),measure_tick+=measure_len}),this._tryAddBPMFromMeta()}_tryAddBPMFromMeta(){if(0===this.beat.bpm.size&&"t"in this._ksmMeta){const initBPM=this._ksmMeta.t;initBPM.match(/^[\d.]+$/)&&this.beat.bpm.add(0,0,parseFloat(initBPM))}}_setKSONNoteInfo(){const noteInfo=this.note={bt:[],fx:[],laser:[]};this._initTreeArr(this.note.laser,2);let longInfo={bt:[null,null,null,null],fx:[null,null]};const cutLongNote=(type,lane)=>{const lit=longInfo[type];if(null===lit[lane])return;const result=this.addNote(type,lane,lit[lane][0],lit[lane][1]);if(!result[0])throw new Error(`Invalid ksh long notes! (${result[1].y} and ${lit[lane][0]} at ${lane} collides)`);lit[lane]=null},addLongInfo=(type,lane,y,l)=>{const lit=longInfo[type];if(null===lit[lane]&&(lit[lane]=[y,0]),lit[lane][0]+lit[lane][1]!=y)throw new Error("Invalid ksh long notes!");lit[lane][1]+=l};let laserSegments=[null,null],laserRange=[1,1];const cutLaserSegment=lane=>{if(null===laserSegments[lane])return;let laser={v:laserSegments[lane].toKSON()};1!==laserSegments[lane].range&&(laser.wide=laserSegments[lane].range),noteInfo.laser[lane].add(laserSegments[lane].iy,laserSegments[lane].getLength(),laser),laserSegments[lane]=null};var lane,y,v;this._ksmMeasures.forEach(measure=>{measure.forEach(kshLine=>{kshLine.mods.forEach(([key,value])=>{switch(key){case"laserrange_l":laserRange[0]="2x"===value?2:1;break;case"laserrange_r":laserRange[1]="2x"===value?2:1}});for(let i=0;i<4;i++){const c=kshLine.bt[i];"0"!==c&&"1"!==c||cutLongNote("bt",i),"0"!==c&&("1"!==c?addLongInfo("bt",i,kshLine.tick,kshLine.len):this.addNote("bt",i,kshLine.tick,0))}for(let i=0;i<2;i++){const c=kshLine.fx[i];"0"!==c&&"2"!==c||cutLongNote("fx",i),"0"!==c&&("2"!==c?addLongInfo("fx",i,kshLine.tick,kshLine.len):this.addNote("fx",i,kshLine.tick,0))}for(let i=0;i<2;i++){const c=kshLine.laser[i];if("-"===c){cutLaserSegment(i);continue}if(":"===c)continue;const pos=KSH_LASER_VALUES.indexOf(c);if(-1===pos)throw new Error("Invalid ksh laser pos value!");lane=i,y=kshLine.tick,v=pos/50,null===laserSegments[lane]&&(laserSegments[lane]=new KSHGraph(!0,{y:y,range:laserRange[lane],collapseTick:KSH_LASER_SLAM_TICK})),laserSegments[lane].push(y,v)}})});for(let i=0;i<4;++i)cutLongNote("bt",i);for(let i=0;i<2;++i)cutLongNote("fx",i);for(let i=0;i<2;++i)cutLaserSegment(i)}}KSHData.create=function(file){try{return new KSHData(file)}catch(e){return console.error(e),null}};class KSONData extends VChartData{}KSONData.create=function(file){return null};class VChartScale{constructor(view){this.view=view,this.editor=view.editor,this.load()}load(){const settings=this.editor.settings;this.columns=settings.get("editor:columns"),this.noteWidth=settings.get("editor:note:width"),this.btNoteHeight=2,this.fxNoteHeight=3,this.laserSlamRatio=1,this.laserFloat=5,this.cursorWidthRatio=1.5,this.tickPropFontSize=12,this.marginSide=settings.get("editor:margin:side"),this.marginBottom=settings.get("editor:margin:bottom"),this.measureScale=settings.get("editor:measure:scale"),this.scrollBarWidth=12,this._computeRests()}setNoteWidth(value){this.noteWidth=value,this._computeRests(),this.view.redraw()}setMarginSide(value){this.marginSide=value,this._computeRests(),this.view.resize()}setMarginBottom(value){this.marginBottom=value,this._computeRests(),this.view.resize()}setMeasureScale(value){this.measureScale=value,this._computeRests(),this.view.redraw()}setColumns(value){this.columns=value,this._computeRests(),this.view.redraw()}_computeRests(){this.wholeNote=this.noteWidth*this.measureScale,this.columnOffset=11*this.noteWidth+this.marginSide,this.fullWidth=this.columnOffset*this.columns+this.marginSide,this.elemWidth=this.fullWidth+this.scrollBarWidth,this.columnLeft=-5.5*this.noteWidth,this.columnRight=5.5*this.noteWidth,this.columnWidth=11*this.noteWidth,this.viewBoxLeft=this.columnLeft-this.marginSide,this.laserPosWidth=5*this.noteWidth,this.laserSlamHeight=CLIP(this.laserSlamRatio*this.noteWidth-2,0,this.noteWidth),this.laneWidth=4*this.noteWidth,this.laneLeft=-2*this.noteWidth,this.laneRight=2*this.noteWidth,this.cursorLeft=this.laneLeft*this.cursorWidthRatio,this.cursorRight=this.laneRight*this.cursorWidthRatio}}class VChartColor{constructor(view){this.view=view,this.editor=view.editor,this.load()}load(){this.hueLaserLeft=180,this.hueLaserRight=300,this.btFill="#FFF",this.btBorder="#AAA",this.btLong="#EEE",this.fxFill="#F90",this.fxBorder="#A40",this.fxLong="#EA0",this.measureLine="#FF0",this.beatLine="#444",this.baseLines="#555",this.cursor="#F00",this.textTimeSig="#9E4",this.textBPM="#6AF"}}const VVIEW_CAMERA_Z=128,VVIEW_EDITOR_UI_Z=10;class VViewColumn{constructor(render,index){this.parent=render,this.index=index,this.enabled=!0,this.camera=new THREE.OrthographicCamera(-50,50,100,0),this.camera.position.set(0,0,VVIEW_CAMERA_Z)}resize(){const view=this.parent.view,scale=view.scale;this.camera.left=scale.columnLeft,this.camera.right=scale.columnRight,this.camera.bottom=-scale.marginBottom,this.camera.top=view.height-scale.marginBottom,this.camera.updateProjectionMatrix()}updateLocation(){const view=this.parent.view,base=view.t2p(view.tickLoc),offset=view.height;this.camera.position.y=base+this.index*offset}render(){if(!this.enabled)return;const renderer=this.parent.renderer,view=this.parent.view,scale=view.scale,left=scale.marginSide+scale.columnOffset*this.index,width=scale.columnWidth,height=view.height;renderer.setViewport(left,0,width,height),renderer.setScissor(left,0,width,height),renderer.setScissorTest(!0),renderer.render(this.parent.scene,this.camera)}}class VTickPropText{constructor(parent,isRight){const scale=parent.render.view.scale;this.parent=parent,this.isRight=isRight;const ctx=this.ctx=document.createElement("canvas").getContext("2d"),fontSize=this.fontSize=scale.tickPropFontSize;this.width=ctx.canvas.width=4*fontSize,this.height=ctx.canvas.height=3*fontSize,ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height),ctx.font=`${fontSize}px monospace`,ctx.textBaseline="top",ctx.textAlign=this.isRight?"right":"left";const texture=this.texture=new THREE.CanvasTexture(ctx.canvas);texture.minFilter=THREE.LinearFilter;const panel=this.panel=new THREE.Mesh(new THREE.PlaneGeometry(ctx.canvas.width,ctx.canvas.height),new THREE.MeshBasicMaterial({map:texture,transparent:!0}));panel.position.x=isRight?scale.columnRight-this.width/2:scale.columnLeft+this.width/2,panel.position.y=ctx.canvas.height/2+2,parent._object.add(panel)}redraw(){const ctx=this.ctx,fontSize=this.fontSize,fields=this.isRight?this.parent._rightFields:this.parent._leftFields;let firstColor=null;ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);const currX=this.isRight?this.width:0;let currY=this.height;return fields.forEach(([field,color])=>{if(!(field in this.parent._texts))return;const text=this.parent._texts[field];0!==text.length&&(currY-=fontSize,ctx.fillStyle=color,firstColor||(firstColor=color),ctx.fillText(text,currX,currY))}),this.texture.needsUpdate=!0,firstColor}}class VTickProp{constructor(render,tick){this.render=render,this.tick=tick,this._initFields(),this._object=new THREE.Object3D,this._object.position.y=this.render.view.t2p(tick),this.render.tickProps.add(this._object),this._lineMaterial=new THREE.LineBasicMaterial({color:"white"}),this._line=new THREE.Line(this.render.cursorLineGeometry,this._lineMaterial),this._object.add(this._line),this._texts={},this._initTextArea()}_initFields(){const color=this.render.view.color;this._leftFields=[],this._rightFields=[["bpm",color.textBPM],["timeSig",color.textTimeSig]]}_initTextArea(){this._leftPanel=new VTickPropText(this,!1),this._rightPanel=new VTickPropText(this,!0),this._redrawFlag=!1}setBPM(bpm){this._setText("bpm",`${bpm}`)}setTimeSig(n,d){this._setText("timeSig",`${n}/${d}`)}_setText(id,value){this._texts[id]=value,this._redrawFlag=!0}redraw(){if(!this._redrawFlag)return;const leftColor=this._leftPanel.redraw(),rightColor=this._rightPanel.redraw(),color=leftColor||rightColor||null;(this._line.visible=null!==color)&&this._lineMaterial.color.set(color),this._redrawFlag=!1}}class VModelTemplate{constructor(type,geometry,material){this.type=type,this.geometry=geometry,this.material=material}create(){return new this.type(this.geometry,this.material)}}class VModelTemplateCollection{constructor(templates){this.templates=templates}create(){const obj=new THREE.Object3D;return this.templates.forEach(template=>{obj.add(template.create())}),obj}}class VViewRender{constructor(view){this.view=view,this.elem=view.elem.querySelector(".chart-view"),this.scene=new THREE.Scene,this.renderer=new THREE.WebGLRenderer({alpha:!0,antialias:!0}),this.renderer.sortObjects=!1,this.renderer.setClearColor(0,0),this.renderer.setSize(this.view.scale.elemWidth,100),this.elem.appendChild(this.renderer.domElement),this._initDrawData(),this.columns=[],this._addColumn()}setCursor(start,end){this.cursorStart.position.y=this.view.t2p(start),this.cursorEnd.position.y=this.view.t2p(end)}clearMeasures(){this._clear(this.measureLines)}addMeasureLine(pos){const measureLine=this.measureLineTemplate.create();measureLine.position.set(0,this.view.t2p(pos),0),this.measureLines.add(measureLine)}addBeatLine(pos){const beatLine=this.beatLineTemplate.create();beatLine.position.set(0,this.view.t2p(pos),0),this.measureLines.add(beatLine)}clearNotes(){this._clear(this.fxLongs),this._clear(this.btLongs),this._clear(this.fxShorts),this._clear(this.btShorts),this.fxNotesByY={},this.btNotesByY={}}addBtNote(lane,pos,len){let note=null;note=0===len?this._addNote(this.btShorts,this.btShortTemplate,lane,pos):this._addNote(this.btLongs,this._createLongNoteTemplate(this.view.scale.noteWidth,1,this.view.color.btLong,len),lane,pos),this.btNotesByY[pos]=note}addFxNote(lane,pos,len){let note=null;note=0===len?this._addNote(this.fxShorts,this.fxShortTemplate,2*lane,pos):this._addNote(this.btLongs,this._createLongNoteTemplate(2*this.view.scale.noteWidth,0,this.view.color.fxLong,len),2*lane,pos),this.fxNotesByY[pos]=note}_addNote(noteCollection,noteTemplate,lane,pos){const scale=this.view.scale,note=noteTemplate.create();return note.position.set((lane-2)*scale.noteWidth,RD(this.view.t2p(pos)),0),noteCollection.add(note),note}clearLasers(){this._clear(this.lasers)}addLaser(index,y,graph){if(!(graph&&"v"in graph&&graph.v.length))return;const laserObject=new THREE.Object3D,scale=this.view.scale,WIDE="wide"in graph?graph.wide:1,HALF_LASER=scale.noteWidth/2-.5,X=v=>WIDE*(v-.5)*scale.laserPosWidth,Y=ry=>this.view.t2p(ry);laserObject.position.y=Y(y);const points=[];let prevX=0,prevY=0;if(graph.v.forEach((gp,ind)=>{const x=X(gp.v),y=Y(gp.ry);if(0===ind||QUAD(points,[prevX-HALF_LASER,prevY],[prevX+HALF_LASER,prevY],[x+HALF_LASER,y],[x-HALF_LASER,y]),"vf"in gp){const xf=X(gp.vf),yf=y+scale.laserSlamHeight;let[xmin,xmax]=[x,xf];x>xf&&([xmin,xmax]=[xf,x]),QUAD(points,[xmin-HALF_LASER,y],[xmax+HALF_LASER,y],[xmax+HALF_LASER,yf],[xmin-HALF_LASER,yf]),[prevX,prevY]=[xf,yf]}else[prevX,prevY]=[x,y]}),0===points.length)return;"vf"in graph.v[graph.v.length-1]&&points.push(prevX-HALF_LASER,prevY,0,prevX+HALF_LASER,prevY,0,prevX,prevY+2*HALF_LASER,0);const geometry=new THREE.BufferGeometry;geometry.setAttribute("position",new THREE.Float32BufferAttribute(points,3)),geometry.computeBoundingSphere();const material=0===index?this.leftLaserBodyMaterial:this.rightLaserBodyMaterial,laserBody=new THREE.Mesh(geometry,material);laserObject.add(laserBody),this.lasers.add(laserObject)}clearTickProps(){this._clear(this.tickProps),this.tickPropsByY={}}addBPMChanges(pos,bpm){this._getTickProp(pos).setBPM(bpm)}addTimeSig(pos,n,d){this._getTickProp(pos).setTimeSig(n,d)}_getTickProp(pos){return pos in this.tickPropsByY?this.tickPropsByY[pos]:this.tickPropsByY[pos]=new VTickProp(this,pos)}resize(){for(this.renderer.setSize(this.view.scale.fullWidth,this.view.height);this.columns.length<this.view.scale.columns;)this._addColumn();this.columns.forEach(column=>{column.resize()})}updateLocation(){this.columns.forEach(column=>{column.updateLocation()})}_addColumn(){const column=new VViewColumn(this,this.columns.length);this.columns.push(column)}render(){for(let y in this.tickPropsByY)this.tickPropsByY[y].redraw();this.columns.forEach(column=>column.render())}_initDrawData(){const scale=this.view.scale;this.laneCrossingLineGeometry=this._createLineGeometry(new THREE.Vector3(scale.laneLeft,0,0),new THREE.Vector3(scale.laneRight,0,0)),this.cursorLineGeometry=this._createLineGeometry(new THREE.Vector3(scale.cursorLeft,0,0),new THREE.Vector3(scale.cursorRight,0,0)),this._initMeasureDrawData(),this._initNoteDrawData(),this._initLaserDrawData(),this._initTickPropData(),this._initEditorUIDrawData()}_initMeasureDrawData(){const color=this.view.color;this.measureLines=this._createGroup(-1),this.measureLineTemplate=new VModelTemplate(THREE.Line,this.laneCrossingLineGeometry,new THREE.LineBasicMaterial({color:color.measureLine})),this.beatLineTemplate=new VModelTemplate(THREE.Line,this.laneCrossingLineGeometry,new THREE.LineBasicMaterial({color:color.beatLine}))}_initNoteDrawData(){const scale=this.view.scale,color=this.view.color;this.fxLongs=this._createGroup(0),this.btLongs=this._createGroup(0),this.fxShorts=this._createGroup(0),this.btShorts=this._createGroup(0),this.fxNotesByY={},this.btNotesByY={},this.btShortTemplate=this._createRectangleTemplate(0,0,scale.noteWidth,scale.btNoteHeight,color.btFill,color.btBorder),this.fxShortTemplate=this._createRectangleTemplate(0,0,2*scale.noteWidth,scale.fxNoteHeight,color.fxFill,color.fxBorder)}_createLongNoteTemplate(width,padding,color,len){return this._createRectangleTemplate(padding,0,width-2*padding,this.view.t2p(len),color)}_initLaserDrawData(){this.lasers=this._createGroup(CLIP(this.view.scale.laserFloat,1,VVIEW_EDITOR_UI_Z)),this.leftLaserBodyMaterial=this._createLaserBodyMaterial(0),this.rightLaserBodyMaterial=this._createLaserBodyMaterial(1)}_createLaserBodyMaterial(index){return new THREE.MeshBasicMaterial({color:this._getLaserBodyColor(index),opacity:.5,transparent:!0})}_getLaserBodyColor(index){const hue=0===index?this.view.color.hueLaserLeft:this.view.color.hueLaserRight,color=new THREE.Color;return color.setHSL(hue/360,1,.6),color}_initTickPropData(){const color=this.view.color;this.tickProps=this._createGroup(VVIEW_EDITOR_UI_Z),this.tickPropsByY={},this.bpmLineTemplate=new VModelTemplate(THREE.Line,this.cursorLineGeometry,new THREE.LineBasicMaterial({color:color.textBPM}))}_initEditorUIDrawData(){const color=this.view.color;this.cursors=this._createGroup(VVIEW_EDITOR_UI_Z);const cursorTemplate=new VModelTemplate(THREE.Line,this.cursorLineGeometry,new THREE.LineBasicMaterial({color:color.cursor}));this.cursorStart=cursorTemplate.create(),this.cursorEnd=cursorTemplate.create(),this.cursors.add(this.cursorStart),this.cursors.add(this.cursorEnd)}_createGroup(z){const group=new THREE.Group;return this.scene.add(group),group.position.z=z,group}_createLineGeometry(a,b){const geometry=new THREE.BufferGeometry;return geometry.setAttribute("position",new THREE.Float32BufferAttribute([a.x,a.y,a.z,b.x,b.y,b.z],3)),geometry.computeBoundingSphere(),geometry}_createPlaneGeometry(x,y,w,h){const geometry=new THREE.BufferGeometry;return geometry.setAttribute("position",new THREE.Float32BufferAttribute([x,y,0,x+w,y,0,x+w,y+h,0,x,y,0,x+w,y+h,0,x,y+h,0],3)),geometry.computeBoundingSphere(),geometry}_createRectangleTemplate(x,y,w,h,fill,stroke){const templates=[],planeGeometry=this._createPlaneGeometry(x+.5,y+.5,w-1,h-1);if(templates.push(new VModelTemplate(THREE.Mesh,planeGeometry,new THREE.MeshBasicMaterial({color:fill}))),stroke){const edges=new THREE.EdgesGeometry(this._createPlaneGeometry(x,y,w,h));templates.push(new VModelTemplate(THREE.Line,edges,new THREE.LineBasicMaterial({color:stroke})))}return new VModelTemplateCollection(templates)}_clear(elem){for(let i=elem.children.length;i-- >0;)elem.remove(elem.children[i])}}class VViewScrollBar{constructor(view){this.view=view,this.elem=view.elem.querySelector(".chart-scrollbar"),this.tickPerPixel=0,this.scrolling=!1,this.initTickLoc=0,this.initMouseY=0,this.elem.addEventListener("mousedown",this.startScroll.bind(this)),this.elem.addEventListener("touchstart",TOUCH(this.startScroll.bind(this)),{passive:!0})}startScroll(event){this.scrolling=!0,this.initMouseY=event.pageY,this.initTickLoc=this.view.tickLoc,this.elem.classList.add("drag")}stopScroll(){this.scrolling=!1,this.elem.classList.remove("drag")}trigger(y){const lastTick=this.view.lastTick,dt=(this.initMouseY-y)*this.tickPerPixel;let newTick=RD(this.initTickLoc+dt);newTick=CLIP(newTick,0,lastTick),this.view.setLocation(newTick)}update(){const lastTick=this.view.lastTick;if(0===lastTick)return void(this.elem.style.display="none");const scale=this.view.scale;this.elem.style.display="block",this.elem.style.width=`${scale.scrollBarWidth}px`;const visibleTicks=this.view.p2t(this.view.height*scale.columns-scale.marginBottom)/lastTick,scrollBarHeight=RD(this.view.height*CLIP(visibleTicks,.05,.9)),scrollBarTop=(this.view.height-scrollBarHeight)*(1-this.view.tickLoc/lastTick);this.elem.style.top=`${scrollBarTop}px`,this.elem.style.height=`${scrollBarHeight}px`,this.tickPerPixel=lastTick/(this.view.height-scrollBarHeight)}}class VViewBaseLines{constructor(view){this.view=view,this.svg=view.elem.querySelector(".chart-baselines"),this.lines=[],this.copiesArr=[],this.currHeight=100,this.bottomOffset=0;const defs=this._createElem(this.svg,"defs"),baseLinesDef=this._createElem(defs,"g");baseLinesDef.id="baseLines";const masterBaseLine=this.master=this._createElem(baseLinesDef,"line");masterBaseLine.id="masterBaseLine",masterBaseLine.setAttribute("x1",0),masterBaseLine.setAttribute("y1",0),masterBaseLine.setAttribute("x2",0),masterBaseLine.setAttribute("y2",this.currHeight),masterBaseLine.setAttribute("stroke",view.color.baseLines),masterBaseLine.setAttribute("stroke-width",1);for(let i=-2;i<=2;++i){if(0===i)continue;const line=this._createElem(baseLinesDef,"use");line.setAttribute("href","#masterBaseLine"),line.setAttribute("x",i*view.scale.noteWidth),this.lines.push([i,line])}this.elem=this._createElem(this.svg,"use"),this.elem.setAttribute("href","#baseLines"),this.copies=this._createElem(this.svg,"g"),this.copies.id="baseLineCopies"}update(){this.currHeight!=this.view.height&&(this.currHeight=this.view.height,this.master.setAttribute("y2",this.currHeight));let bottomOffset=this.view.scale.marginBottom-this.view.t2p(this.view.tickLoc);bottomOffset<0&&(bottomOffset=0),this.bottomOffset!=bottomOffset&&(this.bottomOffset=bottomOffset,this.elem.setAttribute("y",-bottomOffset))}updateNoteWidth(){this.lines.forEach(([i,line])=>{line.setAttribute("x",i*this.view.scale.noteWidth)}),this._updateCopies()}resize(){const scale=this.view.scale;this.svg.setAttribute("width",scale.fullWidth),this.svg.setAttribute("height",this.view.height),this.svg.setAttribute("viewBox",`${scale.viewBoxLeft} 0 ${scale.fullWidth} ${this.view.height}`),this._updateCopies()}_updateCopies(){if(this.copiesArr.length+1!=this.view.scale.columns){this.copiesArr.forEach(elem=>elem.remove()),this.copiesArr=[];for(let i=1;i<this.view.scale.columns;++i){const copy=this._createElem(this.copies,"use");copy.setAttribute("href","#baseLines"),this.copiesArr.push(copy)}}for(let i=1;i<this.view.scale.columns;++i)this.copiesArr[i-1].setAttribute("x",this.view.scale.columnOffset*i)}_createElem(parent,tag){const elem=document.createElementNS(this.svg.namespaceURI,tag);return parent.appendChild(elem),elem}}const VVIEW_RENDER_PRIORITY=Object.freeze({NONE:0,MINOR:1,RESIZE:2,REDRAW:3});class VViewRenderQueue{constructor(view){this.view=view,this.queue=[],this.currPriority=VVIEW_RENDER_PRIORITY.NONE}push(func,priority){if(priority<this.currPriority)return;const triggerAnimationFrame=0==this.queue.length;priority==this.currPriority&&priority<VVIEW_RENDER_PRIORITY.RESIZE?this.queue.push(func.bind(this.view)):(this.queue=[func.bind(this.view)],this.currPriority=priority),triggerAnimationFrame&&window.requestAnimationFrame(this._onAnimationFrame.bind(this))}_onAnimationFrame(){this.queue.forEach(f=>f()),this.queue=[],this.view.render.render(),this.currPriority=VVIEW_RENDER_PRIORITY.NONE}}class VView{constructor(editor){this.editor=editor,this.scale=new VChartScale(this),this.color=new VChartColor(this),this.elem=editor.elem.querySelector(".chart"),this.elem.style.width=`${this.scale.elemWidth}px`,this.tickUnit=960,this.tickLoc=0,this.lastTick=0,this.cursorStartLoc=0,this.cursorEndLoc=0,this._prevNoteWidth=this.scale.noteWidth,this.height=0,this.renderQueue=new VViewRenderQueue(this),this.scrollBar=new VViewScrollBar(this),this.baseLines=new VViewBaseLines(this),this.render=new VViewRender(this),this._redraw(),this.elem.addEventListener("wheel",this.onWheel.bind(this),{passive:!0}),this.elem.addEventListener("mousedown",this.onMouseDown.bind(this)),document.addEventListener("mousemove",this.onMouseMove.bind(this),{passive:!0}),document.addEventListener("mouseup",this.onMouseUp.bind(this),{passive:!0}),document.addEventListener("touchmove",TOUCH(this.onMouseMove.bind(this)),{passive:!0}),document.addEventListener("touchcancel",TOUCH(this.onMouseUp.bind(this)),{passive:!0}),document.addEventListener("touchend",TOUCH(this.onMouseUp.bind(this)),{passive:!0})}t2p(tick){return tick*this.scale.wholeNote/this.tickUnit}p2t(px){return px*this.tickUnit/this.scale.wholeNote}getTopPixel(){return RD(this.scale.marginBottom-this.t2p(this.tickLoc)-this.height)}setLocation(tickLoc){this.tickLoc=isFinite(tickLoc)&&tickLoc>=0?tickLoc:0,this.renderQueue.push(this._updateLocation,VVIEW_RENDER_PRIORITY.MINOR)}setCursor(cursorLoc){null==cursorLoc&&(cursorLoc=this.cursorStartLoc),this.cursorStartLoc=this.cursorEndLoc=isFinite(cursorLoc)&&cursorLoc>0?cursorLoc:0,this.renderQueue.push(this._redrawCursor,VVIEW_RENDER_PRIORITY.MINOR)}redraw(){this.renderQueue.push(this._redraw,VVIEW_RENDER_PRIORITY.REDRAW)}_redraw(){this.tickUnit=this.editor.getTicksPerWholeNote()||960,this.lastTick=this.editor.chartData?this.editor.chartData.getLastTick():0,this._resize(),this._redrawNotes(),this._redrawLasers(),this._updateLocation(),this._redrawMeasures(),this._redrawTickProps(),this._redrawEditorUI()}_redrawNotes(){if(!this.editor.chartData)return;const noteData=this.editor.chartData.note;noteData&&(this.render.clearNotes(),noteData.bt.forEach((btData,lane)=>{btData.traverse(node=>{this.render.addBtNote(lane,node.y,node.l)})}),noteData.fx.forEach((fxData,lane)=>{fxData.traverse(node=>{this.render.addFxNote(lane,node.y,node.l)})}))}_redrawLasers(){if(!this.editor.chartData)return;const noteData=this.editor.chartData.note;if(!noteData)return;const laserData=noteData.laser;laserData&&(this.render.clearLasers(),laserData.forEach((tree,ind)=>{tree.traverse(node=>{this.render.addLaser(ind,node.y,node.data)})}))}_redrawMeasures(){if(this.render.clearMeasures(),this.render.addMeasureLine(0),!this.editor.chartData)return;const beatInfo=this.editor.chartData.beat;if(!beatInfo||!beatInfo.time_sig)return;let measureTick=0,measureIndex=0,currTimeSigInd=-1;for(;currTimeSigInd+1<beatInfo.time_sig.length||measureTick<=this.lastTick;){if(currTimeSigInd+1<beatInfo.time_sig.length){beatInfo.time_sig[currTimeSigInd+1].idx<=measureIndex&&++currTimeSigInd}const currTimeSig=currTimeSigInd>=0?beatInfo.time_sig[currTimeSigInd]:{v:{n:4,d:4}},currMeasureLength=currTimeSig.v.n*this.tickUnit/currTimeSig.v.d;measureIndex>0&&this.render.addMeasureLine(measureTick);for(let i=1;i<currTimeSig.v.n;++i)this.render.addBeatLine(measureTick+i*(this.tickUnit/currTimeSig.v.d));++measureIndex,measureTick+=currMeasureLength}measureTick>0&&this.render.addMeasureLine(measureTick)}_redrawTickProps(){if(this.render.clearTickProps(),!this.editor.chartData)return;const beatInfo=this.editor.chartData.beat;if(beatInfo&&(beatInfo.bpm&&beatInfo.bpm.traverse(node=>{this.render.addBPMChanges(node.y,node.data)}),beatInfo.time_sig)){let measureTick=0,prevMeasureInd=0,currMeasureLength=this.tickUnit;beatInfo.time_sig.forEach(sig=>{measureTick+=(sig.idx-prevMeasureInd)*currMeasureLength,prevMeasureInd=sig.idx,currMeasureLength=sig.v.n*this.tickUnit/sig.v.d,this.render.addTimeSig(measureTick,sig.v.n,sig.v.d)})}}_redrawEditorUI(){this._redrawCursor()}_redrawCursor(){this.render.setCursor(this.cursorStartLoc,this.cursorEndLoc)}resize(){this.renderQueue.push(this._resize,VVIEW_RENDER_PRIORITY.RESIZE)}_resize(){this.elem.style.width=`${this.scale.elemWidth}px`,this.height=this.elem.clientHeight,this.baseLines.resize(),this.render.resize(),this._updateLocation(),this._updateNoteWidth()}_updateNoteWidth(){this._prevNoteWidth!==this.scale.noteWidth&&(this._prevNoteWidth=this.scale.noteWidth,this.baseLines.updateNoteWidth())}onMouseDown(event){this.elem.contains(event.target)&&!this.scrollBar.elem.contains(event.target)&&this.setCursorWithMouse(event.offsetX,event.offsetY)}onMouseMove(event){0!==event.which&&this.scrollBar.scrolling&&this.scrollBar.trigger(event.pageY)}onMouseUp(event){this.scrollBar.scrolling&&(this.scrollBar.trigger(event.pageY),this.scrollBar.stopScroll())}onWheel(event){if(!this.editor.chartData||!this.editor.chartData.beat)return;const deltaTick=this.tickUnit/16;event.deltaY<0?this.setLocation(this.tickLoc+deltaTick):event.deltaY>0&&this.setLocation(this.tickLoc-deltaTick)}setCursorWithMouse(x,y){let clickTick=this.getTick(x,y);clickTick=ALIGN(this.editor._editSnapTick,clickTick),this.setCursor(clickTick)}getTick(x,y){let column=Math.floor(x/this.scale.columnOffset);column>=this.scale.columns&&(column=this.scale.columns-1);const effectivePos=y-column*this.height;return-this.p2t(this.getTopPixel()+effectivePos)}_updateLocation(){this.render.updateLocation(),this.baseLines.update(),this.scrollBar.update()}}class VKeyManager{constructor(editor){this.editor=editor,this.ops={},this.bindMap={},this.queue=[],this._initOps(),this.makeBindMap(),document.body.addEventListener("keydown",this._onKeyPress.bind(this))}clearAllBinds(){this.bindMap={}}bind(key,op){this.bindMap[key]=op}_isMatch(template){if((template=template.split(" ")).length<this.queue.length)return!1;for(let i=0;i<template.length;++i){const t=template[i];if("*"===t)continue;const q=this.queue[i+(this.queue.length-template.length)];if(t!==q&&(!t.includes("/")||!t.split("/").includes(q)))return!1}return!0}_onKeyPress(event){if("target"in event)switch(event.target.tagName.toUpperCase()){case"INPUT":case"BUTTON":case"TEXTAREA":return}const code=SIMPLECODE(event);if(code){switch(code){case"Shift":case"ShiftRight":case"Ctrl":case"CtrlRight":case"Alt":case"AltRight":return}this.queue.push(code);for(let key in this.bindMap)if(this._isMatch(key)){event.preventDefault();const op=this.bindMap[key];return op in this.ops?this.ops[op].call(this.editor):console.warn("Operation '%s' is not registered to keyManager.",op),void(this.queue=[])}this.queue.length>=16&&this.queue.shift()}}_initOps(){this._registerOp("undo",this.editor.undo),this._registerOp("redo",this.editor.redo),this._registerOp("add-bt-a",this.editor.addBt.bind(this.editor,0)),this._registerOp("add-bt-b",this.editor.addBt.bind(this.editor,1)),this._registerOp("add-bt-c",this.editor.addBt.bind(this.editor,2)),this._registerOp("add-bt-d",this.editor.addBt.bind(this.editor,3)),this._registerOp("add-fx-l",this.editor.addFx.bind(this.editor,0)),this._registerOp("add-fx-r",this.editor.addFx.bind(this.editor,1)),this._registerOp("max-440",function(){document.location.href="https://youtu.be/5tCEzv_bu9Q"})}_registerOp(op,func){this.ops[op]=func}makeBindMap(){this.clearAllBinds(),this.bind("Ctrl+Z","undo"),this.bind("Ctrl+Y","redo"),this.bind("1","add-bt-a"),this.bind("2","add-bt-b"),this.bind("3","add-bt-c"),this.bind("4","add-bt-d"),this.bind("5","add-fx-l"),this.bind("6","add-fx-r"),this.bind("Up Up Down Down Left Right Left Right B A Enter","max-440")}}class VTask{constructor(editor){this.editor=editor,this.chartData=editor.chartData,this._inverse=null}_validate(){return!1}_commit(){throw new Error("Not yet implemented!")}_makeInverse(){return null}inverse(){return this._inverse?this._inverse:this._inverse=this._makeInverse()}commit(){return!(!this._commonValidate()||!this._validate())&&(this.inverse(),!!this._commit()||(console.error("Commit failed",this),!1))}_commonValidate(){return!(!this.editor||!this.chartData||this.editor.chartData!==this.chartData)}}class VTaskManager{constructor(editor){this.editor=editor,this.history=[],this.nextInd=0}clear(){this.history=[],this.nextInd=0}undo(){if(0===this.nextInd||0===this.history.length)return!1;const inverse=this.history[this.nextInd-1].inverse();return!!inverse&&(inverse.commit()?(--this.nextInd,!0):(console.error("Failed to undo",this.history[this.nextInd-1]),!1))}redo(){return this.history.length!==this.nextInd&&(this.history[this.nextInd].commit()?(++this.nextInd,!0):(console.error("Failed to redo",this.history[this.nextInd]),!1))}do(task){return!!task&&(!!task.commit()&&(this.history.length>this.nextInd&&(this.history=this.history.slice(0,this.nextInd)),this.history.push(task),++this.nextInd,!0))}}class VNoteAddTask extends VTask{constructor(editor,type,lane,tick,len){super(editor),this.type=type,this.lane=lane,this.tick=tick,this.len=len}_validate(){const noteData=this.chartData.getNoteData(this.type,this.lane);return!noteData||!noteData.intersects(this.tick,this.len)}_commit(){const result=this.chartData.addNote(this.type,this.lane,this.tick,this.len);return!(!result||!1===result[0])&&(this.editor.view.setCursor(this.tick),this.editor.view.redraw(),!0)}_makeInverse(){return new VNoteDelTask(this.editor,this.type,this.lane,this.tick)}}class VNoteDelTask extends VTask{constructor(editor,type,lane,tick){super(editor),this.type=type,this.lane=lane,this.tick=tick}_validate(){const noteData=this.chartData.getNoteData(this.type,this.lane);if(!noteData)return!1;const node=noteData.get(this.tick);return!!node&&node.y===this.tick}_commit(){return!!this.chartData.delNote(this.type,this.lane,this.tick)&&(this.editor.view.setCursor(this.tick),this.editor.view.redraw(),!0)}_makeInverse(){const node=this.chartData.getNoteData(this.type,this.lane).get(this.tick);return new VNoteAddTask(this.editor,this.lane,this.tick,node.l)}}class VToolbar{constructor(editor){if(this.editor=editor,this.elem=editor.elem.querySelector(".toolbar"),this.tabs=[].slice.call(this.elem.querySelectorAll(".toolbar-tab li")),this.panels=[].slice.call(this.elem.querySelectorAll(".toolbar-panel")),this.tabs.length!=this.panels.length)throw new Error(`VToolbar: ${this.tabs.length} tabs != ${this.panels.length} panels!`);this.currTab=-1,this.changeTab(0),this.tabs.forEach((elem,ind)=>{elem.addEventListener("click",event=>{this.changeTab(ind)})}),this._setupHome(),this._setupOptions()}changeTab(ind){!isFinite(ind)||ind<0||ind>=this.tabs.length||(this.currTab>=0&&this.currTab<this.tabs.length&&(this.tabs[this.currTab].classList.remove("active"),this.panels[this.currTab].classList.remove("active")),this.currTab=ind,this.tabs[ind].classList.add("active"),this.panels[ind].classList.add("active"))}_setupHome(){this._button("toolbar-open","toolbar-open-desc",this.editor.showOpenFileDialog),this._button("toolbar-save-kson","toolbar-save-kson-desc",this.editor.saveToKSON),this._button("toolbar-save-ksh","toolbar-save-ksh-desc",this.editor.saveToKSH),this._bind("toolbar-edit-snap",null,v=>{(v=+v)!==this.editor.editSnap&&this.editor.setEditSnap(v)}),this._bind("toolbar-note-width","editor:note:width",v=>this.editor.view.scale.setNoteWidth(+v)),this._bind("toolbar-measure-scale","editor:measure:scale",v=>this.editor.view.scale.setMeasureScale(+v)),this._bind("toolbar-columns","editor:columns",v=>this.editor.view.scale.setColumns(+v),v=>isFinite(+v)&&+v>=1&&+v<=8&&+v===Math.round(+v))}_setupOptions(){this._bind("toolbar-language-select","ui:language",v=>L10N.l(v)),this._bind("toolbar-margin-side","editor:margin:side",v=>this.editor.view.scale.setMarginSide(+v)),this._bind("toolbar-margin-bottom","editor:margin:bottom",v=>this.editor.view.scale.setMarginBottom(+v))}_button(className,title,onClick){for(let elem of this.elem.querySelectorAll(`.${className}`))title&&(elem.title=L10N.t(title)),elem.addEventListener("click",event=>{onClick.call(this.editor)})}_bind(className,configName,onChange,validate){const settings=this.editor.settings;validate||(validate=(()=>!0));const elems=this.elem.querySelectorAll(`.${className}`),isConfig=settings.isConfig(configName);let initCalled=!1;const initValue=v=>{initCalled||(initCalled=!0,onChange(v))};for(let elem of elems.values()){switch(elem.tagName.toUpperCase()){case"SELECT":return isConfig&&elem.querySelector(`option[value="${settings.get(configName)}"]`).setAttribute("selected",!0),elem.addEventListener("change",event=>{validate(elem.value)&&(isConfig&&settings.set(configName,elem.value),onChange(elem.value))}),void initValue(elem.value);case"INPUT":return isConfig&&(elem.value=settings.get(configName)),isConfig&&(elem.title=`${L10N.t("toolbar-default")} ${settings.defaultValue(configName)}`),elem.addEventListener("change",event=>{validate(elem.value)&&(isConfig&&settings.set(configName,elem.value),onChange(elem.value))}),void initValue(elem.value)}console.warn(`VToolbar bind failed: tag ${elem.tagName} is not well understood.`)}}}const readFileList=files=>Promise.all([].map.call(files,file=>new Promise((resolve,reject)=>{const reader=new FileReader;reader.addEventListener("error",reject),reader.addEventListener("load",event=>{resolve(reader.result)}),reader.readAsText(file)})));class VEditor{constructor(elem){this.elem=elem,this.chartData=null,this.settings=new VSettings,L10N.l(this.settings.get("ui:language")),this._editSnapBeat=16,this._editSnapTick=1,this.view=new VView(this),this.toolbar=new VToolbar(this),this.taskManager=new VTaskManager(this),this.keyManager=new VKeyManager(this),this._dropFileIndicator=elem.querySelector(".drop-file-indicator"),this._dropFileIndicatorShown=!1,this._addEventListeners()}getTicksPerWholeNote(){return this.chartData?4*(this.chartData.beat&&this.chartData.beat.resolution||240):0}setEditSnap(snap){const oldSnapBeat=this._editSnapBeat;this._setEditSnap(snap);const resolution=this.getTicksPerWholeNote();if(resolution&&resolution%this._editSnapBeat==0?this._editSnapTick=resolution/this._editSnapBeat:this._editSnapTick=1,oldSnapBeat!==this._editSnapBeat||this._editSnapBeat!==snap)for(let elem of this.elem.querySelectorAll(".toolbar .toolbar-edit-snap"))elem.value=this._editSnapBeat}_setEditSnap(snap){if(this.chartData){if(snap>0&&isFinite(snap)&&0===snap|snap&&this.chartData){const resolution=this.getTicksPerWholeNote(),dir=snap<this._editSnapBeat?-1:1;if(snap>resolution&&(snap=resolution),resolution%snap==0)return void(this._editSnapBeat=snap);for(let i=snap-dir;i!=this._editSnapBeat;i-=dir)if(resolution%i==0)return void(this._editSnapBeat=i);for(let i=snap+dir;i>0&&i<=resolution;i+=dir)if(resolution%i==0)return void(this._editSnapBeat=i)}}else this._editSnapBeat=CLIP(Math.round(snap),1,64)}updateEditSnap(){this.setEditSnap(this._editSnapBeat)}onResize(){this.view.resize()}undo(){this.taskManager.undo()}redo(){this.taskManager.redo()}addBt(index){this.chartData&&this.taskManager.do(new VNoteAddTask(this,"bt",index,this.view.cursorStartLoc,0))}addFx(index){this.chartData&&this.taskManager.do(new VNoteAddTask(this,"fx",index,this.view.cursorStartLoc,0))}showOpenFileDialog(){const fileInput=document.createElement("input");fileInput.setAttribute("type","file"),fileInput.setAttribute("accept",".ksh, .kson"),fileInput.addEventListener("change",event=>{this.openFileList(fileInput.files),fileInput.remove()}),fileInput.click()}openFileList(files){1==files.length&&readFileList(files).then(fileContents=>{console.time("Parsing");const chartData=VChartData.create(fileContents[0]);console.timeEnd("Parsing"),null!==chartData?(this.setChartData(chartData),this.view.setLocation(0),this.view.redraw()):alert(L10N.t("error-reading-chart-data"))}).catch(err=>{console.error(err)})}setChartData(chartData){if(chartData&&(this.chartData=chartData),!this.chartData)return;const trimmedChartName=this.chartData.meta.title.trim(),chartDifficulty=["NOV","ADV","EXH","INF"][this.chartData.meta.difficulty.idx];this.setChartTitle(`${trimmedChartName} [${chartDifficulty}]`),this.updateEditSnap()}setChartTitle(title){document.title=""===title?"VOLTEdit":`${title} - VOLTEdit`}saveToKSON(){this.chartData&&this.saveFile(this.chartData.toKSON(),"chart.kson")}saveToKSH(){this.chartData}saveFile(text,fileName){const blob=new Blob([text],{type:"text/plain"}),elem=document.createElement("a");elem.setAttribute("href",window.URL.createObjectURL(blob)),elem.setAttribute("download",fileName),elem.style.display="none",document.body.appendChild(elem),elem.click(),document.body.removeChild(elem),window.URL.revokeObjectURL(blob)}onDragEnter(event){event.preventDefault(),event.dataTransfer.types.includes("Files")&&this._showDropFileIndicator()}onDragOver(event){event.preventDefault()}onDragLeave(event){event.preventDefault(),null===event.fromElement&&this._hideDropFileIndicator()}onDrop(event){event.preventDefault(),this._hideDropFileIndicator();const files=event.dataTransfer.files;0!=files.length&&this.openFileList(files)}_addEventListeners(){window.addEventListener("resize",this.onResize.bind(this)),this.elem.addEventListener("dragenter",this.onDragEnter.bind(this),!1),this.elem.addEventListener("dragover",this.onDragOver.bind(this),!1),this.elem.addEventListener("dragleave",this.onDragLeave.bind(this),!1),document.addEventListener("drop",this.onDrop.bind(this),!1)}_showDropFileIndicator(){this._dropFileIndicatorShown||(this._dropFileIndicatorShown=!0,this._dropFileIndicator.classList.add("active"))}_hideDropFileIndicator(){this._dropFileIndicatorShown&&(this._dropFileIndicatorShown=!1,this._dropFileIndicator.classList.remove("active"))}}